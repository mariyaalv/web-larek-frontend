# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка

```
export interface ICard {
	id: string;
	description: string;
	image: string;
	title: string;
	category: string;
	price?: number;
	isInBasket: boolean;
	index: number;
}
```

Товар

```
export interface IProduct {
	id: string;
	description?: string;
	image: string;
	title: string;
	category: string;
	price?: number;
}
```

Заказ

```
export interface IOrder {
	payment: TPayment;
	email: string;
	phone: string;
	address: string;
	total: number;
	items: string[];
}
```

Данные покупателя на первом этапе оформления заказа в форме оплаты

```
export type TFormOfPayment = Pick<IOrder, 'payment' | 'address' | null>;
```

Данные покупателя на втором этапе оформления заказа в форме контактной информации

```
export type TFormOfContact = Pick<IOrder, 'email' | 'phone'>;
```

Данные об успешном завершении заказа

```
export type TSuccessData = { id: string; total: string };
```

Данные о способе оплаты

```
export type TPayment = 'card' | 'cash' | null;
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой представления, отвечает за отображение данных на странице, 
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Конструктор:
- `constructor(baseUrl: string, options: RequestInit = {})`- принимает базовый URL и глобальные опции для всех запросов(опционально)
Методы:
- `handleResponse(response: Response): Promise<object>` - обрабатывает ответа с сервера. Если ответ с сервера пришел, то возвращается его в формате json, в противном случае формирует ошибку
- `get(uri: string): Promise<object>` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post(uri: string, data: object, method: ApiPostMethods = 'POST'): Promise<object>` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.\

Поля:
- `_events: Map<EventName, Set<Subscriber>>` - хранит события
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on<T extends object>(event: EventName, callback: (data: T) => void): void` - подписка на событие
- `emit<T extends object>(event: string, data?: T): void` - инициализация события
- `trigger<T extends object>(event: string, context?: Partial<T>): (data: T) => void` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие
- `onAll(callback: (event: EmitterEvent) => void)` - подписка на все события
- `offAll()` - для сброса событий

### Слой данных

#### Класс CardsData
Класс отвечает за хранение и логику работы с каталогом товаров.\
Конструктор класса принимает инстант брокера событий.
- constructor(events: IEvents)

В полях класса хранятся следующие данные:
- _cards: IProduct[] - массив объектов карточек
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getCard(cardId: string): IProduct | undefined - параметром принимает id карточки и возвращает карточку, соответствующую переданному id
- set cards(value: IProduct[]): void` - записывает массив товаров
- get cards(): IProduct[] - возвращает массив товаров

#### Класс OrderData
Класс отвечает за хранение и логику работы с данными заказа.\
Конструктор класса принимает инстант брокера событий.
- constructor(events: IEvents)

В полях класса хранятся следующие данные:
- _paymentInfo: TFormOfPayment - платежная информация
- _contactInfo: TFormOfContact - контактная информация
- order: IOrder - заказ
- formErrors: FormErrors = {} - объект данных об ошибках валидации
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- getOrderData(): IOrder- для получения данных о заказе
- clearOrder(): void- очищает данные о способе оплаты и адресе
- clearUserContacts(): void - очищает контактные данные покупателя
- checkValidation(): boolean - проверяет данные заказа
а так-же сеттеры и геттеры для сохранения и получения данных из полей класса:
 - `set paymentInfo(info: TFormOfPayment): void` - запись платежной информации
 - `get paymentInfo(): TFormOfPayment` - возвращает данные о способе оплаты и адресе
 - `set contactInfo(info: TFormOfContact): void` - запись контактной информации
 - `get contactInfo(): TFormOfContact` - возвращает контактную информацию

#### Класс BasketData
Класс отвечает за хранение и логику работы с данными корзины товаров.\
Конструктор класса принимает инстант брокера событий.
- constructor(events: IEvents)

В полях класса хранятся следующие данные:
- _cardsInBasket: IProduc[] - коллекция товаров в корзине
- _total: number - итоговая стоимость товаров в корзине
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных

Так же класс предоставляет набор методов для взаимодействия с этими данными.
- addProductInBasket(product: IProduct): void - добавляет товар в корзину
- deleteProductFromBasket(id: string): void - удаляет товар из корзины
- clearBasket(): void - очищать корзину
- getTotal(): number - устанавливает итоговую стоимость
- isInBasket(productId: string): boolean - проверить, есть ли товар в корзине
- getProductsInBasket(): IProduct[] - для получения списка товаров в корзине
- getProductIdsInBasket(): string[] - для получения списка товаров в корзине по уникальному идентификатору
а так-же сеттеры и геттеры для сохранения и получения данных из полей класса:
- `set total(value: number): void` - запись общей суммы заказа
- `get cardsInBasket(): IProduct[]` - возвращает массив товаров в корзине
- `set cardsInBasket(cardsInBasket: IProduct[]): void` - добавление в массив товаров покупателя


### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс View
Абстрактный базовый класс View служит шаблоном для классов слоя представления.\

Поля:
- _container: HTMLElement - DOM элемент, передаваемый в конструкторе
- events: IEvents - брокер событий

Конструктор:
- constructor(container: HTMLElemen, events: IEvents) - принимает DOM элемент компонента и экземпляр класса `EventEmitter` для возможности инициации событий

Методы, геттеры и сеттеры:
- render(data?: Partial<T>): HTMLElement - возвращает отрисованный html элемент по переданным данным
- setText(element: HTMLElement, value: unknown): void - установить текстовое содержимое
- setImage(element: HTMLImageElement, src: string, alt?: string): void - установить изображение с алтернативным текстом\

#### Класс Page
Расширяет класс View. Реализует отображение главной страницы приложения.\

Параметры в конструкторе:
- параметры `View`.

Поля:
- _catalog: HTMLElement - элемент для отображения списка товаров в корзине
- _counter: HTMLSpanElement - счётчик количества товаров в корзине
- _wrapper: HTMLElement - элемент внешней обертки страницы
- _basket: HTMLButtonElement; - элемент кнопки корзины

Сеттеры:
- `set catalog(cards: HTMLElement[]): void` - заменяет содержимое _catalog на переданные HTML-элементы
- `set counter(value: number): void` - устанавливает значение в счётчике товаров корзины
- `set locked(value: boolean) void` - отвечате за блокировку / разблокировку прокрутки страницы

#### Класс Modal
Расширяет класс View. Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна на клик в оверлей и кнопку-крестик для закрытия попапа.\

Параметры в конструкторе:
- параметры `View`.

Поля класса
- closeButton: HTMLButtonElement - элемент кнопки закрытия
- content: HTMLDivElement - элемент разметки внутреннего контейнера

Методы:
- `open(): void` - открывает модальное окно
- `close(): void` - закрывает модальное окно

#### Класс Form
Расширяет класс View. Предназначен для реализации формы содержащей поля ввода. При сабмите инициирует событие, передавая в него объект с данными из полей ввода формы. При изменении данных в полях ввода инициирует событие изменения данных. Предоставляет методы для отображения ошибок и управления активностью кнопки сохранения.\

Параметры в конструкторе:
- параметры `View`.

Поля класса:
- submitButton: HTMLButtonElement - кнопка подтверждения
- inputsList: HTMLInputElement[] - коллекция всех полей ввода формы
- _errors: HTMLSpanElement; - элемент разметки для вывода ошибки

Сеттеры:
- `set valid(value: boolean): void` - устанавливает статус валидности формы: валидна / нет
- `set errors(value: string)` - устанавливает текст ошибки

#### Класс FormOfPayment
Расширяет класс Form. Форма для оформления заказа с указанием способа оплаты и адреса доставки.\

Параметры в конструкторе:
- параметры `Form`

Поля:
- _buttonContainer: HTMLDivElement - контейнер, содержащий кнопки "онлайн" и "при получении"
- _buttonCard: HTMLButtonElement - кнопка "онлайн"
- _buttonCash: HTMLButtonElement - кнопка "при получении"
- inputAddress: HTMLInputElement - поле для ввода адреса
- orderButtonElement: HTMLButtonElement - кнопка оформления заказа (далее)
- _payment: TPayment | null - способ оплаты

Геттеры и сеттеры:
- `set address(value: string): void` - устанавливает адресс в соответствующее поле формы
- `get address(): string` - возвращает адресс
- `set payment(value: TPayment | null): void` - устанавливает способ оплаты
- `set payment(): TPayment | null` - возвращает способ оплаты

#### Класс FormOfContact
Расширяет класс Form. Форма для оформления заказа с указанием номера телефона и email покупателя.\

Параметры в конструкторе:
- параметры `Form`

Поля
- inputEmail: HTMLInputElement - текстовое поле для email
- inputPhone: HTMLInputElement - текстовое поле для номера телефона

Геттеры и сеттеры:
- `set email(value: string): void` - устанавливает email в соответствующее поле формы
- `get email(): string` - возвращает email из поля ввода email
- `set phone(value: string): void` - устанавливает номер телефона в соответствующее поле формы
- `qet phone(): string` - возвращает номер телефона из поля ввода phone

#### Класс Card
Расширяет класс View. Отвечает за отображение карточки с товаром, задавая в карточке данные названия, изображения, категории, описания и цены. Класс используется для отображения карточек на странице сайта. В конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.\

Поля класса содержат элементы разметки элементов карточки.\
Поля:
- _id: string - уникальный идентификатор товара
- _titleElement: HTMLHeadingElement - элемент разметки наименования товара
- _price: HTMLSpanElement - элемент разметки цены на товар
- _image: HTMLImageElement - элемент разметки фотографии продукта
- _category: HTMLSpanElement - элемент разметки категории товара
- description: HTMLParagraphElement - элемент разметки с детальным описанием о товаре
- button: HTMLButtonElement - элемент кнопки добавления и удаления товара из корзины
- _index: HTMLSpanElement - элемент разметки порядкового номера товара в корзине

Конструктор принимает следующие аргументы:
- template - экземпляр типа HTMLTemplateElement, который является шаблоном элемента в разметке
- events - экземпляр `EventEmitter` для инициации событий
- action? - экземпляр типа ICardAction содержащий обработчик события нажатия мышью на кнопку (или контейнер в случае списка)

Сеттеры:
- `set category(category: string): void` - устанавливает категорию товара
- `set index(index: number): void` - устанавливает индекс товара
- `set id(id: string): void` - устанавливает уникальный идентификатор товара
- `set title(title: string): void` - устанавливает название товара
- `set price(price: string): void` - устанавливает цену товара
- `set description(description: string): void` - устанавливает описание товара
- `set image(src: string): void` - устанавливает изображение товара
- `set isInBasket(state: boolean): void` - устанавливает статус товара (в корзине?)

#### Класс Basket
Расширяет класс View. Реализует отображение корзины с добавленными в нее товарами. \

Параметры в конструкторе:
- параметры `View`

Поля:
- _list: HTMLElement[] | null - список товаров
- _total: HTMLSpanElement - html элемент, отвечающий за отображение общей стоимости товаров

Сеттеры:
- `set list(cards: HTMLElement[]): void` - заменяет содержимое списка _list этими элементами
- `set total(total: number)` - устанавливает общую стоимость товаров в корзине

#### Класс Success
Расширяет класс View. Отображает уведомление об успешной покупке.\

Параметры в конструкторе:
- параметры `View`

Методы, геттеры и сеттеры:
- `set total(value: number)` - устанавливает количество потраченных средств в html элемент messageTotalSum.

### Слой коммуникации

#### Класс ActionAPI
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.\

Методы, геттеры и сеттеры:
- `getProducts(): Promise<IProduct[]>` - получает с сервера сданные товаров
- `getProductItem(id: string): Promise<IProduct>` - получает с сервера конкретный товар по id
- `postOrder(order: IOrder): Promise<TSuccessData>` - отправляет post запрос на сервер, содержащий данные о заказе. Для этого нужны данные о заказе (способ оплаты, адрес, email, телефон)
и информация о купленных товарах(их id, общая стоимость).

## Взаимодействие компонентов
Код, описывающий за взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.  

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*

- `cards:changed` - изменение массива данных товаров
- `basket:changed` - изменение содержимого корзины

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*

- `formErrors:change` - событие отображение ошибки по состоянию валидности полей формы оформления заказа (для двух эапов)
- `modal:open` - открытие модального окна
- `modal:close` - закрытие модального окна
- `preview:selected` - выбрана карточка в списке для предварительно просмотра с возможностью добавления в корзину
- `preview:submit` -  добавление / удаление товара из корзны через модальное окно просмотра товара
- `basket:delete` - удаление товара из корзины
- `basket:submit` - переход к оформлению товаров в корзине
- `order:valid` - событие, сообщающее о необходимости валидации формы оплаты
- `contacts:valid` - событие, сообщающее о необходимости валидации формы контактных данных покупателя
- `order:submit` - сохраняет способ оплаты и адрес доставки и осуществляет переход на следующий этап оформления заказа
- `contacts:submit` - сохраняет email и номер телефона покупателя и осуществляет переход на следующий этап оформления заказа
- `success: submit` - возврат к списку продуктов после успешного оформления заказа